# ميزة المواعيد الأونلاين - Online Appointments Feature

## نظرة عامة
تم إضافة ميزة جديدة لإدارة المواعيد المحجوزة عبر الإنترنت من خلال API خارجي. هذه الميزة تسمح للسكرتيرة بعرض وإدارة المواعيد التي يحجزها المرضى عبر موقع الويب أو تطبيق الجوال.

## المتطلبات
- خدمة API خارجية تعمل على `http://localhost:4000`
- مكتبة `requests` (تم إضافتها إلى requirements.txt)

## المميزات الجديدة

### 1. عرض المواعيد الأونلاين
- **المسار**: `/online-appointments`
- **الوصول**: من النافجيشن الجانبي للسكرتيرة
- **المميزات**:
  - عرض جميع المواعيد المحجوزة عبر الإنترنت
  - إحصائيات سريعة حسب حالة الموعد
  - تحديث تلقائي كل 5 دقائق
  - رابط مباشر للاتصال برقم المريض

### 2. إدارة المواعيد
#### أ) تسجيل الاتصال
- **الوظيفة**: تسجيل أن السكرتيرة اتصلت بالمريض
- **الطريقة**: POST `/online-appointments/call/<appointment_id>`
- **التأثير**: تغيير حالة الموعد إلى "تم الاتصال"
- **متاح للحالات**: قيد التأكيد

#### ب) تأكيد الموعد
- **الوظيفة**: تأكيد الموعد بعد التحدث مع المريض
- **الطريقة**: POST `/online-appointments/confirm/<appointment_id>`
- **التأثير**: تغيير حالة الموعد إلى "مؤكد"
- **متاح للحالات**: قيد التأكيد، تم الاتصال

#### ج) تحديد كمكتمل
- **الوظيفة**: تحديد الموعد كمكتمل بعد إنجازه
- **الطريقة**: POST `/online-appointments/complete/<appointment_id>`
- **التأثير**: تغيير حالة الموعد إلى "مكتمل"
- **متاح للحالات**: مؤكد

#### د) إلغاء الموعد
- **الوظيفة**: إلغاء الموعد إذا لزم الأمر
- **الطريقة**: POST `/online-appointments/cancel/<appointment_id>`
- **التأثير**: تغيير حالة الموعد إلى "ملغي"
- **متاح للحالات**: جميع الحالات عدا ملغي ومكتم

### 3. الفلاتر والبحث
- **فلترة حسب الحالة**: اختيار حالة معينة من قائمة منسدلة
- **فلترة حسب التاريخ**: اختيار تاريخ محدد
- **الجمع بين الفلاتر**: إمكانية استخدام أكثر من فلتر في نفس الوقت
- **مسح الفلاتر**: إعادة تعيين جميع الفلاتر بنقرة واحدة

## API المطلوب

### 1. جلب المواعيد (مع الفلاتر)
```
GET http://localhost:4000/api/appointments/all?token=123456
GET http://localhost:4000/api/appointments/all?token=123456&status=مؤكد
GET http://localhost:4000/api/appointments/all?token=123456&date=2024-01-15
GET http://localhost:4000/api/appointments/all?token=123456&status=قيد التأكيد&date=2024-01-15
```

**الاستجابة المتوقعة:**
```json
{
  "appointments": [
    {
      "id": 1,
      "name": "أحمد محمد",
      "phone": "0501234567",
      "date": "2024-01-15",
      "time": "10:30",
      "note": "فحص دوري",
      "status": "قيد التأكيد",
      "created_at": "2024-01-10 14:30:25"
    }
  ],
  "count": 1
}
```

### 2. تحديث حالة الموعد
```
PUT http://localhost:4000/api/appointments/{appointment_id}/status?token=123456
Content-Type: application/json

{
  "status": "تم الاتصال"
}
```

**أمثلة على الحالات:**
- `{"status": "تم الاتصال"}` - لتسجيل الاتصال
- `{"status": "مؤكد"}` - لتأكيد الموعد
- `{"status": "ملغي"}` - لإلغاء الموعد
- `{"status": "مكتمل"}` - لتحديد الموعد كمكتمل

## حالات المواعيد
- **قيد التأكيد**: موعد جديد يحتاج إلى اتصال من السكرتيرة
- **تم الاتصال**: تم الاتصال بالمريض ولكن لم يتم تأكيد الموعد بعد
- **مؤكد**: موعد مؤكد ومجدول
- **ملغي**: موعد ملغي

## التثبيت والإعداد

### 1. تحديث المتطلبات
```bash
pip install -r requirements.txt
```

### 2. تشغيل خدمة API الخارجية
تأكد من تشغيل خدمة API الخارجية على `http://localhost:4000`

### 3. الوصول للميزة
1. سجل الدخول كسكرتيرة
2. انقر على "المواعيد الأونلاين" في القائمة الجانبية
3. ستظهر قائمة بجميع المواعيد المحجوزة عبر الإنترنت

## الملفات المضافة/المحدثة

### ملفات جديدة:
- `clinic_app/templates/secretary/online_appointments.html` - صفحة عرض المواعيد الأونلاين

### ملفات محدثة:
- `clinic_app/secretary/routes.py` - إضافة 5 routes جديدة للمواعيد الأونلاين مع دعم الفلاتر
- `clinic_app/templates/layout.html` - إضافة رابط في النافجيشن
- `requirements.txt` - إضافة مكتبة requests

## استكشاف الأخطاء

### 1. خطأ في الاتصال بـ API
- **الرسالة**: "لا يمكن الاتصال بخدمة المواعيد الأونلاين"
- **الحل**: تأكد من تشغيل خدمة API على `http://localhost:4000`

### 2. لا توجد مواعيد
- **الرسالة**: "لا توجد مواعيد أونلاين حالياً"
- **السبب**: إما لا توجد مواعيد في قاعدة البيانات أو خدمة API غير متاحة

### 3. فشل في تحديث الموعد
- **الرسالة**: "فشل في تسجيل الاتصال/تأكيد الموعد/إلغاء الموعد"
- **الحل**: تحقق من استجابة API وتأكد من صحة التوكن

## المميزات المستقبلية المقترحة
1. إشعارات push للمواعيد الجديدة
2. تصدير المواعيد إلى Excel
3. إحصائيات مفصلة عن المواعيد الأونلاين
4. ربط المواعيد الأونلاين بنظام التذاكر الداخلي
5. إرسال رسائل SMS تذكيرية للمرضى

## الأمان
- استخدام توكن للمصادقة مع API الخارجي
- التحقق من صحة البيانات المرسلة والمستقبلة
- معالجة الأخطاء بشكل آمن وعدم كشف معلومات حساسة

## ملاحظات للمطورين
- يتم استخدام مكتبة `requests` للاتصال بـ API الخارجي
- تم إضافة timeout 5 ثوان لتجنب التأخير الطويل
- يتم معالجة جميع أخطاء الشبكة والاستجابة بشكل مناسب
- الصفحة تدعم التحديث التلقائي كل 5 دقائق