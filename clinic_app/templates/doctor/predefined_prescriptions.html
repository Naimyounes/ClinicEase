{% extends "layout.html" %}
{% block content %}
<!-- Container Ù…Ù†ÙØµÙ„ Ù„Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© -->
<div id="dropdown-container" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10000;">
    <!-- Ø³ØªØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© Ù‡Ù†Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
</div>

<div class="container">
    <div class="row mb-4">
        <div class="col-md-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('doctor.dashboard') }}">Tableau de bord mÃ©decin</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Ordonnances prÃ©dÃ©finies</li>
                </ol>
            </nav>
        </div>
    </div>

    <!-- Ø¥Ø¶Ø§ÙØ© ÙˆØµÙØ© Ø¬Ø¯ÙŠØ¯Ø© -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">
                        <i class="fas fa-plus-circle me-2"></i>
                        Ajouter une ordonnance prÃ©dÃ©finie
                    </h3>
                </div>
                <div class="card-body">
                    <form id="add_prescription_form">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="form-group">
                                    <label class="form-control-label mb-2">
                                        <i class="fas fa-prescription-bottle me-1"></i>
                                        Nom de l'ordonnance
                                    </label>
                                    <input type="text" 
                                           id="prescription_name" 
                                           class="form-control" 
                                           placeholder="Ex: Ordonnance pour grippe, Traitement hypertension..."
                                           required>
                                </div>
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <button type="submit" class="btn btn-success w-100 btn-lg" id="add_prescription_btn">
                                    <i class="fas fa-plus"></i> Ajouter l'ordonnance
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙˆØµÙØ§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹ -->
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h3 class="mb-0">
                        <i class="fas fa-list me-2"></i>
                        Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙˆØµÙØ§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹
                    </h3>
                </div>
                <div class="card-body">
                    <div id="prescriptions_list">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
                            </div>
                            <p class="mt-2">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆØµÙØ§Øª...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸš€ ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© - Ø¨Ø¯Ø¡ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©');
    
    // Variables globales
    const addPrescriptionForm = document.getElementById('add_prescription_form');
    const prescriptionNameInput = document.getElementById('prescription_name');
    const prescriptionsList = document.getElementById('prescriptions_list');
    const addPrescriptionBtn = document.getElementById('add_prescription_btn');
    const dropdownContainer = document.getElementById('dropdown-container');
    
    // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØµÙØ§Øª ÙˆØ§Ù„Ø£Ø¯ÙˆÙŠØ©
    let predefinedPrescriptions = [];
    let availableMedications = [
        {% for medication in medications %}
        {
            id: {{ medication.id }},
            name: "{{ medication.name }}",
            dosage: "{{ medication.dosage or '' }}"
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ];

    console.log('ğŸ’Š Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø§Ù„Ù…ØªØ§Ø­Ø©:', availableMedications.length);

    // ==================== Event Delegation ====================
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… event delegation Ù„Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©
    
    // Ø²Ø± Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆØµÙØ© (Ø«Ø§Ø¨Øª)
    if (addPrescriptionForm) {
        addPrescriptionForm.addEventListener('submit', function(e) {
            console.log('ğŸ“ Ø¥Ø±Ø³Ø§Ù„ Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆØµÙØ©');
            e.preventDefault();
            const name = prescriptionNameInput.value.trim();
            if (name) {
                addPrescription(name);
            } else {
                showAlert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„ÙˆØµÙØ©', 'warning');
            }
        });
    }

    // Event delegation Ù„Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©
    document.addEventListener('click', function(e) {
        console.log('ğŸ–±ï¸ Ù†Ù‚Ø± Ø¹Ù„Ù‰:', e.target.className);
        
        // Ø²Ø± Ø¹Ø±Ø¶/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙˆØµÙØ©
        if (e.target.closest('.toggle-prescription-btn')) {
            console.log('ğŸ‘ï¸ Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± Ø¹Ø±Ø¶/Ø¥Ø®ÙØ§Ø¡');
            const btn = e.target.closest('.toggle-prescription-btn');
            const prescriptionId = btn.getAttribute('data-prescription-id');
            const details = document.getElementById(`prescription-${prescriptionId}`);
            const icon = btn.querySelector('i');
            
            if (details.style.display === 'none' || !details.style.display) {
                details.style.display = 'block';
                icon.className = 'fas fa-eye-slash';
                btn.innerHTML = '<i class="fas fa-eye-slash"></i> Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø¯ÙˆÙŠØ©';
            } else {
                details.style.display = 'none';
                icon.className = 'fas fa-eye';
                btn.innerHTML = '<i class="fas fa-eye"></i> Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¯ÙˆÙŠØ©';
            }
        }
        
        // Ø²Ø± Ø­Ø°Ù Ø§Ù„ÙˆØµÙØ©
        else if (e.target.closest('.delete-prescription-btn')) {
            console.log('ğŸ—‘ï¸ Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± Ø­Ø°Ù Ø§Ù„ÙˆØµÙØ©');
            const btn = e.target.closest('.delete-prescription-btn');
            const prescriptionId = btn.getAttribute('data-prescription-id');
            deletePrescription(prescriptionId);
        }
        
        // Ø²Ø± Ø­Ø°Ù Ø§Ù„Ø¯ÙˆØ§Ø¡
        else if (e.target.closest('.remove-medication-btn')) {
            console.log('âŒ Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± Ø­Ø°Ù Ø§Ù„Ø¯ÙˆØ§Ø¡');
            const btn = e.target.closest('.remove-medication-btn');
            const prescriptionId = btn.getAttribute('data-prescription-id');
            const medicationId = btn.getAttribute('data-medication-id');
            removeMedicationFromPrescription(prescriptionId, medicationId);
        }
        
        // Ø²Ø± Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙˆØ§Ø¡
        else if (e.target.closest('.add-medication-btn')) {
            console.log('â• Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙˆØ§Ø¡');
            const btn = e.target.closest('.add-medication-btn');
            const prescriptionId = btn.getAttribute('data-prescription-id');
            addMedicationToPrescription(prescriptionId);
        }
        
        // Ø²Ø± Ù…Ø³Ø­ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
        else if (e.target.closest('.clear-selection')) {
            console.log('ğŸ§¹ Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± Ù…Ø³Ø­ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±');
            const btn = e.target.closest('.clear-selection');
            const form = btn.closest('.add-medication-form');
            clearMedicationSelection(form);
        }
        
        // Ø§Ø®ØªÙŠØ§Ø± Ø¯ÙˆØ§Ø¡ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
        else if (e.target.closest('.medication-option')) {
            console.log('ğŸ’Š Ø§Ø®ØªÙŠØ§Ø± Ø¯ÙˆØ§Ø¡ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©');
            const option = e.target.closest('.medication-option');
            const prescriptionId = option.getAttribute('data-prescription-id');
            selectMedication(option, prescriptionId);
        }
        
        // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
        else if (!e.target.closest('.medication-search-wrapper') && !e.target.closest('.medication-dropdown')) {
            document.querySelectorAll('.medication-dropdown').forEach(dropdown => {
                dropdown.remove();
            });
        }
    });

    // Event delegation Ù„Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø£Ø¯ÙˆÙŠØ©
    document.addEventListener('input', function(e) {
        if (e.target.classList.contains('medication-search')) {
            console.log('ğŸ” Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø£Ø¯ÙˆÙŠØ©:', e.target.value);
            const prescriptionId = e.target.getAttribute('data-prescription-id');
            searchMedications(e.target, prescriptionId);
        }
    });

    document.addEventListener('focus', function(e) {
        if (e.target.classList.contains('medication-search')) {
            if (e.target.value.length >= 2) {
                const prescriptionId = e.target.getAttribute('data-prescription-id');
                searchMedications(e.target, prescriptionId);
            }
        }
    }, true);

    // ==================== Functions ====================

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆØµÙØ§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…
    function loadPredefinedPrescriptions() {
        console.log('ğŸ“¥ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆØµÙØ§Øª...');
        
        fetch('/doctor/api/predefined_prescriptions')
            .then(response => {
                console.log('ğŸ“¡ Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø®Ø§Ø¯Ù…:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('ğŸ“Š Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©:', data);
                predefinedPrescriptions = data;
                renderPrescriptions();
            })
            .catch(error => {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆØµÙØ§Øª:', error);
                showAlert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆØµÙØ§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹', 'danger');
                prescriptionsList.innerHTML = `
                    <div class="alert alert-danger text-center">
                        <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                        <h5>Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h5>
                        <p class="mb-0">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆØµÙØ§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹</p>
                    </div>
                `;
            });
    }

    // Ø¹Ø±Ø¶ Ø§Ù„ÙˆØµÙØ§Øª
    function renderPrescriptions() {
        console.log('ğŸ¨ Ø¹Ø±Ø¶ Ø§Ù„ÙˆØµÙØ§Øª:', predefinedPrescriptions.length);
        
        if (predefinedPrescriptions.length === 0) {
            prescriptionsList.innerHTML = `
                <div class="alert alert-info text-center">
                    <i class="fas fa-info-circle fa-2x mb-3"></i>
                    <h5>Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØµÙØ§Øª Ù…Ø­Ø¯Ø¯Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹</h5>
                    <p class="mb-0">Ù‚Ù… Ø¨Ø¥Ø¶Ø§ÙØ© ÙˆØµÙØ© Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø£Ø¹Ù„Ø§Ù‡</p>
                </div>
            `;
            return;
        }

        let html = '';
        predefinedPrescriptions.forEach(prescription => {
            html += createPrescriptionCard(prescription);
        });
        
        prescriptionsList.innerHTML = html;
        console.log('âœ… ØªÙ… Ø¹Ø±Ø¶ Ø§Ù„ÙˆØµÙØ§Øª Ø¨Ù†Ø¬Ø§Ø­');
    }

    // Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø·Ø§Ù‚Ø© ÙˆØµÙØ©
    function createPrescriptionCard(prescription) {
        const medicationsHtml = prescription.medications.map(med => `
            <tr>
                <td><strong>${med.medication.name}</strong></td>
                <td>${med.medication.dosage || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                <td>${med.quantity || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                <td>${med.instructions || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                <td>
                    <button type="button" 
                            class="btn btn-sm btn-danger remove-medication-btn" 
                            data-prescription-id="${prescription.id}" 
                            data-medication-id="${med.medication.id}"
                            title="Ø­Ø°Ù Ø§Ù„Ø¯ÙˆØ§Ø¡">
                        <i class="fas fa-times"></i>
                    </button>
                </td>
            </tr>
        `).join('');

        return `
            <div class="card mb-3 prescription-card" data-prescription-id="${prescription.id}">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-prescription-bottle me-2 text-primary"></i>
                        ${prescription.name}
                    </h5>
                    <div>
                        <button class="btn btn-sm btn-outline-primary toggle-prescription-btn" 
                                type="button" 
                                data-prescription-id="${prescription.id}">
                            <i class="fas fa-eye"></i> Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¯ÙˆÙŠØ©
                        </button>
                        <button type="button" 
                                class="btn btn-sm btn-danger delete-prescription-btn" 
                                data-prescription-id="${prescription.id}"
                                title="Ø­Ø°Ù Ø§Ù„ÙˆØµÙØ©">
                            <i class="fas fa-trash"></i> Ø­Ø°Ù
                        </button>
                    </div>
                </div>
                <div class="prescription-details" id="prescription-${prescription.id}" style="display: none;">
                    <div class="card-body">
                        <h6 class="mb-3">
                            <i class="fas fa-pills me-2"></i>
                            Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø§Ù„Ù…Ø¶Ø§ÙØ© (${prescription.medications.length}):
                        </h6>
                        
                        ${prescription.medications.length > 0 ? `
                            <div class="table-responsive mb-4">
                                <table class="table table-hover table-bordered">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Ø§Ù„Ø¯ÙˆØ§Ø¡</th>
                                            <th>Ø§Ù„Ø¬Ø±Ø¹Ø©</th>
                                            <th>Ø§Ù„ÙƒÙ…ÙŠØ©/Ø§Ù„Ù…Ø¯Ø©</th>
                                            <th>Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª</th>
                                            <th width="80">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${medicationsHtml}
                                    </tbody>
                                </table>
                            </div>
                        ` : `
                            <div class="alert alert-warning text-center mb-4">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø¯ÙˆÙŠØ© Ù…Ø¶Ø§ÙØ© Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙˆØµÙØ©
                            </div>
                        `}
                        
                        <hr>
                        <h6 class="mb-3">
                            <i class="fas fa-plus me-2"></i>
                            Ø¥Ø¶Ø§ÙØ© Ø¯ÙˆØ§Ø¡ Ø¬Ø¯ÙŠØ¯:
                        </h6>
                        <div class="add-medication-form" data-prescription-id="${prescription.id}">
                            <div class="row">
                                <div class="col-md-3">
                                    <label class="form-label">Ø§Ù„Ø¯ÙˆØ§Ø¡:</label>
                                    <div class="medication-search-wrapper">
                                        <input type="text" 
                                               class="form-control medication-search" 
                                               placeholder="Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¯ÙˆØ§Ø¡..."
                                               data-prescription-id="${prescription.id}"
                                               autocomplete="off">
                                        <div class="selected-medication mt-1" style="display: none;">
                                            <small class="text-muted">Ø§Ù„Ø¯ÙˆØ§Ø¡ Ø§Ù„Ù…Ø®ØªØ§Ø±: </small>
                                            <span class="badge bg-primary selected-med-name"></span>
                                            <button type="button" class="btn btn-sm btn-outline-secondary ms-1 clear-selection">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Ø§Ù„ÙƒÙ…ÙŠØ©/Ø§Ù„Ù…Ø¯Ø©:</label>
                                    <input type="text" 
                                           class="form-control quantity-input" 
                                           placeholder="Ù…Ø«Ù„: 3 Ø£ÙŠØ§Ù…ØŒ 10 Ø­Ø¨Ø§Øª"
                                           data-prescription-id="${prescription.id}">
                                </div>
                                <div class="col-md-5">
                                    <label class="form-label">Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª:</label>
                                    <input type="text" 
                                           class="form-control instructions-input" 
                                           placeholder="Ù…Ø«Ù„: Ø­Ø¨Ø© ÙˆØ§Ø­Ø¯Ø© ÙƒÙ„ 8 Ø³Ø§Ø¹Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„Ø£ÙƒÙ„"
                                           data-prescription-id="${prescription.id}">
                                </div>
                                <div class="col-md-2 d-flex align-items-end">
                                    <button type="button" 
                                            class="btn btn-success w-100 add-medication-btn" 
                                            data-prescription-id="${prescription.id}">
                                        <i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ©
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    // Ø¥Ø¶Ø§ÙØ© ÙˆØµÙØ© Ø¬Ø¯ÙŠØ¯Ø©
    function addPrescription(name) {
        console.log('â• Ø¥Ø¶Ø§ÙØ© ÙˆØµÙØ© Ø¬Ø¯ÙŠØ¯Ø©:', name);
        
        // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø²Ø± Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
        addPrescriptionBtn.disabled = true;
        addPrescriptionBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙØ©...';
        
        const data = { name: name };
        
        fetch('/doctor/api/predefined_prescriptions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            console.log('ğŸ“¥ Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆØµÙØ©:', data);
            if (data.success) {
                showAlert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆØµÙØ© Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                prescriptionNameInput.value = '';
                loadPredefinedPrescriptions();
            } else {
                showAlert(data.message || 'Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆØµÙØ©', 'danger');
            }
        })
        .catch(error => {
            console.error('âŒ Ø®Ø·Ø£:', error);
            showAlert('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆØµÙØ©', 'danger');
        })
        .finally(() => {
            // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø±
            addPrescriptionBtn.disabled = false;
            addPrescriptionBtn.innerHTML = '<i class="fas fa-plus"></i> Ajouter l\'ordonnance';
        });
    }

    // Ø­Ø°Ù ÙˆØµÙØ©
    function deletePrescription(prescriptionId) {
        console.log('ğŸ—‘ï¸ Ø­Ø°Ù ÙˆØµÙØ©:', prescriptionId);
        
        if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„ÙˆØµÙØ©ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø§.')) {
            return;
        }

        fetch(`/doctor/api/predefined_prescriptions/${prescriptionId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            console.log('ğŸ“¥ Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø­Ø°Ù Ø§Ù„ÙˆØµÙØ©:', data);
            if (data.success) {
                showAlert('ØªÙ… Ø­Ø°Ù Ø§Ù„ÙˆØµÙØ© Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                loadPredefinedPrescriptions();
            } else {
                showAlert(data.message || 'Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„ÙˆØµÙØ©', 'danger');
            }
        })
        .catch(error => {
            console.error('âŒ Ø®Ø·Ø£:', error);
            showAlert('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„ÙˆØµÙØ©', 'danger');
        });
    }

    // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø£Ø¯ÙˆÙŠØ©
    function searchMedications(searchInput, prescriptionId) {
        const searchTerm = searchInput.value.toLowerCase().trim();
        
        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
        const existingDropdown = document.getElementById(`medication-dropdown-${prescriptionId}`);
        if (existingDropdown) {
            existingDropdown.remove();
        }
        
        if (searchTerm.length < 2) {
            return;
        }

        const filteredMeds = availableMedications.filter(med => 
            med.name.toLowerCase().includes(searchTerm) || 
            (med.dosage && med.dosage.toLowerCase().includes(searchTerm))
        );

        if (filteredMeds.length > 0) {
            createMedicationDropdown(searchInput, filteredMeds, prescriptionId);
        }
    }

    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© Ù„Ù„Ø£Ø¯ÙˆÙŠØ©
    function createMedicationDropdown(searchInput, medications, prescriptionId) {
        const dropdown = document.createElement('div');
        dropdown.id = `medication-dropdown-${prescriptionId}`;
        dropdown.className = 'medication-dropdown';
        
        let dropdownHTML = '';
        medications.slice(0, 10).forEach(med => {
            const displayName = med.dosage ? `${med.name} (${med.dosage})` : med.name;
            dropdownHTML += `
                <div class="dropdown-item medication-option p-2 border-bottom" 
                     data-id="${med.id}" 
                     data-name="${med.name}"
                     data-dosage="${med.dosage || ''}"
                     data-prescription-id="${prescriptionId}"
                     style="cursor: pointer;">
                    <div class="fw-bold">${med.name}</div>
                    ${med.dosage ? `<small class="text-muted">${med.dosage}</small>` : ''}
                </div>
            `;
        });
        
        if (medications.length > 10) {
            dropdownHTML += `
                <div class="p-2 text-center text-muted">
                    <small>... Ùˆ ${medications.length - 10} Ù†ØªØ§Ø¦Ø¬ Ø£Ø®Ø±Ù‰</small>
                </div>
            `;
        }
        
        dropdown.innerHTML = dropdownHTML;
        
        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆØ¶Ø¹
        const inputRect = searchInput.getBoundingClientRect();
        dropdown.style.position = 'fixed';
        dropdown.style.top = inputRect.bottom + 'px';
        dropdown.style.left = inputRect.left + 'px';
        dropdown.style.width = inputRect.width + 'px';
        dropdown.style.zIndex = '10001';
        dropdown.style.display = 'block';
        dropdown.style.pointerEvents = 'auto';
        
        dropdownContainer.appendChild(dropdown);
    }

    // Ø§Ø®ØªÙŠØ§Ø± Ø¯ÙˆØ§Ø¡
    function selectMedication(option, prescriptionId) {
        const form = document.querySelector(`.add-medication-form[data-prescription-id="${prescriptionId}"]`);
        const searchInput = form.querySelector('.medication-search');
        const selectedDiv = form.querySelector('.selected-medication');
        const selectedName = form.querySelector('.selected-med-name');
        
        const medicationData = {
            id: option.getAttribute('data-id'),
            name: option.getAttribute('data-name'),
            dosage: option.getAttribute('data-dosage')
        };
        
        const displayName = medicationData.dosage ? 
            `${medicationData.name} (${medicationData.dosage})` : 
            medicationData.name;
        
        selectedName.textContent = displayName;
        selectedDiv.style.display = 'block';
        searchInput.style.display = 'none';
        searchInput.setAttribute('data-selected-id', medicationData.id);
        
        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
        const dropdown = document.getElementById(`medication-dropdown-${prescriptionId}`);
        if (dropdown) {
            dropdown.remove();
        }
    }

    // Ù…Ø³Ø­ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¯ÙˆØ§Ø¡
    function clearMedicationSelection(form) {
        const searchInput = form.querySelector('.medication-search');
        const selectedDiv = form.querySelector('.selected-medication');
        
        selectedDiv.style.display = 'none';
        searchInput.style.display = 'block';
        searchInput.value = '';
        searchInput.removeAttribute('data-selected-id');
        searchInput.focus();
    }

    // Ø¥Ø¶Ø§ÙØ© Ø¯ÙˆØ§Ø¡ Ù„Ù„ÙˆØµÙØ©
    function addMedicationToPrescription(prescriptionId) {
        console.log('â• Ø¥Ø¶Ø§ÙØ© Ø¯ÙˆØ§Ø¡ Ù„Ù„ÙˆØµÙØ©:', prescriptionId);
        
        const form = document.querySelector(`.add-medication-form[data-prescription-id="${prescriptionId}"]`);
        const searchInput = form.querySelector('.medication-search');
        const quantityInput = form.querySelector('.quantity-input');
        const instructionsInput = form.querySelector('.instructions-input');
        const addBtn = form.querySelector('.add-medication-btn');
        
        const medicationId = searchInput.getAttribute('data-selected-id');
        const quantity = quantityInput.value.trim();
        const instructions = instructionsInput.value.trim();
        
        console.log('ğŸ“Š Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙˆØ§Ø¡:', { medicationId, quantity, instructions });
        
        if (!medicationId) {
            showAlert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø¯ÙˆØ§Ø¡', 'warning');
            return;
        }
        
        if (!instructions) {
            showAlert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª', 'warning');
            return;
        }
        
        // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø²Ø± Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
        addBtn.disabled = true;
        addBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙØ©...';
        
        const data = {
            medication_id: medicationId,
            quantity: quantity,
            instructions: instructions
        };
        
        fetch(`/doctor/api/predefined_prescriptions/${prescriptionId}/medications`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            console.log('ğŸ“¥ Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙˆØ§Ø¡:', data);
            if (data.success) {
                showAlert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙˆØ§Ø¡ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                clearMedicationSelection(form);
                quantityInput.value = '';
                instructionsInput.value = '';
                loadPredefinedPrescriptions();
            } else {
                showAlert(data.message || 'Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙˆØ§Ø¡', 'danger');
            }
        })
        .catch(error => {
            console.error('âŒ Ø®Ø·Ø£:', error);
            showAlert('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙˆØ§Ø¡', 'danger');
        })
        .finally(() => {
            // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø±
            addBtn.disabled = false;
            addBtn.innerHTML = '<i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ©';
        });
    }

    // Ø­Ø°Ù Ø¯ÙˆØ§Ø¡ Ù…Ù† Ø§Ù„ÙˆØµÙØ©
    function removeMedicationFromPrescription(prescriptionId, medicationId) {
        console.log('âŒ Ø­Ø°Ù Ø¯ÙˆØ§Ø¡ Ù…Ù† Ø§Ù„ÙˆØµÙØ©:', prescriptionId, medicationId);
        
        if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¯ÙˆØ§Ø¡ØŸ')) {
            return;
        }

        fetch(`/doctor/api/predefined_prescriptions/${prescriptionId}/medications/${medicationId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            console.log('ğŸ“¥ Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø­Ø°Ù Ø§Ù„Ø¯ÙˆØ§Ø¡:', data);
            if (data.success) {
                showAlert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¯ÙˆØ§Ø¡ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                loadPredefinedPrescriptions();
            } else {
                showAlert(data.message || 'Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¯ÙˆØ§Ø¡', 'danger');
            }
        })
        .catch(error => {
            console.error('âŒ Ø®Ø·Ø£:', error);
            showAlert('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¯ÙˆØ§Ø¡', 'danger');
        });
    }

    // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© ØªÙ†Ø¨ÙŠÙ‡
    function showAlert(message, type) {
        console.log('ğŸ”” Ø¹Ø±Ø¶ ØªÙ†Ø¨ÙŠÙ‡:', message, type);
        
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        alertDiv.style.top = '20px';
        alertDiv.style.right = '20px';
        alertDiv.style.zIndex = '10002';
        alertDiv.style.minWidth = '300px';
        
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(alertDiv);
        
        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    console.log('ğŸ”„ Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
    loadPredefinedPrescriptions();
});
</script>
{% endblock scripts %}

{% block styles %}
<style>
.card {
    border: none;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    transition: box-shadow 0.15s ease-in-out;
}

.card:hover {
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
}

.card-header {
    font-weight: 600;
    border-bottom: 1px solid rgba(0, 0, 0, 0.125);
}

.table th {
    background-color: #f8f9fa;
    font-weight: 600;
    border-top: none;
}

.table td {
    vertical-align: middle;
}

.btn-lg {
    font-size: 1.1rem;
    font-weight: 500;
}

.alert {
    border: none;
    border-radius: 0.5rem;
}

.breadcrumb-item a {
    text-decoration: none;
}

.breadcrumb-item a:hover {
    text-decoration: underline;
}

/* Styles pour la recherche de mÃ©dicaments */
.medication-search-wrapper {
    position: relative;
}

.medication-dropdown {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    background-color: white;
    max-height: 200px;
    overflow-y: auto;
    position: fixed;
    z-index: 10001;
    pointer-events: auto;
}

.medication-option {
    transition: background-color 0.15s ease-in-out;
    border-bottom: 1px solid #f8f9fa;
}

.medication-option:hover {
    background-color: #f8f9fa !important;
}

.medication-option:last-child {
    border-bottom: none;
}

.selected-medication .badge {
    font-size: 0.875rem;
    padding: 0.5rem 0.75rem;
}

.prescription-card {
    transition: transform 0.2s ease-in-out;
}

.prescription-card:hover {
    transform: translateY(-2px);
}

.form-control:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

.table-responsive {
    border-radius: 0.375rem;
    overflow: hidden;
}

.btn-sm {
    font-size: 0.875rem;
}

.alert-dismissible {
    padding-right: 3rem;
}

.form-label {
    font-weight: 600;
    color: #495057;
}

.spinner-border {
    width: 3rem;
    height: 3rem;
}

/* ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
.btn {
    cursor: pointer;
    transition: all 0.2s ease-in-out;
}

.btn:hover {
    transform: translateY(-1px);
}

.btn:disabled {
    cursor: not-allowed;
    transform: none;
}
</style>
{% endblock styles %}