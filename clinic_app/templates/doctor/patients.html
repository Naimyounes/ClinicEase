{% extends "layout.html" %}
{% block extra_head %}
<style>
  /* Patients page enhancements */
  .search-card { border: 1px solid #e9ecef; position: relative; z-index: 1055; overflow: visible !important; }
  .search-card .card-body { overflow: visible !important; }
  .search-input-group .form-control { padding-left: 2.4rem; }
  .search-input-icon { position: absolute; left: .75rem; top: 50%; transform: translateY(-50%); color: #6c757d; }
  .clear-btn { display: none; }
  .search-has-text .clear-btn { display: inline-flex; }
  #search-results { display: none; }
  .results-popover { max-height: 360px; overflow-y: auto; border: 1px solid rgba(0,0,0,.08); top: calc(100% + .25rem); z-index: 1060; }
  .results-popover .list-group-item { padding: .75rem 1rem; }
  .results-popover .name { font-weight: 600; }
  .results-popover .phone { color: #6c757d; font-size: .9rem; }
  .results-popover .match { background: #fff3cd; border-radius: .25rem; padding: 0 .2rem; }
  .results-empty, .results-error { padding: .75rem 1rem; color: #6c757d; }
  .table thead th { position: sticky; top: 0; background: #f8f9fa; z-index: 1; }
  @media (max-width: 576px) {
    .search-actions { margin-top: .75rem; }
  }
</style>
{% endblock %}
{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Liste des patients</h1>
    </div>
    
    <!-- Formulaire de recherche instantanée -->
    <div class="card mb-4 search-card">
        <div class="card-body">
            <div class="row g-3 align-items-center">
                <div class="col-12 col-md-8 position-relative">
                    <div class="search-input-group position-relative">
                        <i class="fas fa-search search-input-icon"></i>
                        <input type="text" id="live-search" class="form-control" placeholder="Rechercher par nom, téléphone ou adresse..." value="{{ search }}" autocomplete="off">
                        <button type="button" id="clear-search" class="btn btn-sm btn-outline-secondary position-absolute end-0 top-50 translate-middle-y me-2 clear-btn">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div id="search-results" class="position-absolute w-100 shadow rounded bg-white results-popover"></div>
                </div>
                <div class="col-6 col-md-2 search-actions">
                    <button id="search-btn" class="btn btn-primary w-100">
                        <i class="fas fa-search me-1"></i> Rechercher
                    </button>
                </div>
                <div class="col-6 col-md-2">
                    <a href="{{ url_for('doctor.list_patients') }}" class="btn btn-outline-secondary w-100">
                        <i class="fas fa-rotate-left me-1"></i> Réinitialiser
                    </a>
                </div>
            </div>
            <form id="search-form" action="{{ url_for('doctor.list_patients') }}" method="get" class="d-none">
                <input type="hidden" name="search" id="search-hidden">
            </form>
        </div>
    </div>

    <!-- Liste des patients -->
    <div class="card">
        <div class="card-header bg-white border-bottom d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-users me-2 text-primary"></i>Patients enregistrés</h5>
            <span class="text-muted small">Page {{ patients.page }} / {{ patients.pages or 1 }}</span>
        </div>
        <div class="card-body">
            {% if patients.items %}
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead>
                            <tr class="text-muted small">
                                <th>#</th>
                                <th>Nom</th>
                                <th>Téléphone</th>
                                <th>Âge</th>
                                <th>Inscription</th>
                                <th>Consultations</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for patient in patients.items %}
                                <tr>
                                    <td class="text-muted">{{ loop.index + (patients.page-1) * patients.per_page }}</td>
                                    <td>
                                        <div class="fw-semibold">{{ patient.full_name }}</div>
                                        <div class="text-muted small">ID: {{ patient.id }}</div>
                                    </td>
                                    <td>{{ patient.phone or '—' }}</td>
                                    <td>
                                        {% if patient.age %}
                                            <span class="badge bg-light text-dark">{{ patient.age }} ans</span>
                                        {% else %}
                                            <span class="text-muted">Non spécifié</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ patient.created_at.strftime('%Y-%m-%d') }}</td>
                                    <td>
                                        {% set visit_count = patient.visits|selectattr('doctor_id', 'eq', current_user.id)|list|length %}
                                        {% if visit_count > 0 %}
                                            <span class="badge bg-success-subtle text-success"><i class="fas fa-check-circle me-1"></i>{{ visit_count }} visite{{ 's' if visit_count>1 else '' }}</span>
                                        {% else %}
                                            <span class="badge bg-secondary-subtle text-secondary">Aucune visite</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-end">
                                        <div class="btn-group" role="group">
                                            <a href="{{ url_for('doctor.patient_details', patient_id=patient.id) }}" class="btn btn-sm btn-outline-primary" title="Détails">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <a href="{{ url_for('doctor.edit_patient_from_doctor', patient_id=patient.id) }}" class="btn btn-sm btn-outline-secondary" title="Modifier">
                                                <i class="fas fa-pen"></i>
                                            </a>
                                            <a href="{{ url_for('doctor.patient_visit', patient_id=patient.id) }}" class="btn btn-sm btn-primary" title="Nouvelle consultation">
                                                <i class="fas fa-stethoscope me-1"></i>Examen
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Navigation entre les pages -->
                <nav aria-label="Page navigation" class="mt-4">
                    <ul class="pagination justify-content-center">
                        {% if patients.has_prev %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('doctor.list_patients', page=patients.prev_num, search=search) }}">Précédent</a>
                            </li>
                        {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">Précédent</span>
                            </li>
                        {% endif %}

                        {% for page_num in patients.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                            {% if page_num %}
                                {% if patients.page == page_num %}
                                    <li class="page-item active">
                                        <span class="page-link">{{ page_num }}</span>
                                    </li>
                                {% else %}
                                    <li class="page-item">
                                        <a class="page-link" href="{{ url_for('doctor.list_patients', page=page_num, search=search) }}">{{ page_num }}</a>
                                    </li>
                                {% endif %}
                            {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">...</span>
                                </li>
                            {% endif %}
                        {% endfor %}

                        {% if patients.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('doctor.list_patients', page=patients.next_num, search=search) }}">Suivant</a>
                            </li>
                        {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">Suivant</span>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
            {% else %}
                <div class="alert alert-info text-center">
                    <i class="fas fa-info-circle me-2"></i>Aucun résultat correspondant à la recherche
                </div>
            {% endif %}
        </div>
    </div>

    <div class="mt-4">
        <a href="{{ url_for('doctor.dashboard') }}" class="btn btn-secondary">Retour au tableau de bord</a>
    </div>
</div>

<!-- Code de recherche instantanée -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    const searchInput = document.getElementById('live-search');
    const searchResults = document.getElementById('search-results');
    const searchBtn = document.getElementById('search-btn');
    const searchForm = document.getElementById('search-form');
    const searchHidden = document.getElementById('search-hidden');
    let searchTimeout;

    // Move results popover to body to avoid clipping and stacking issues
    if (searchResults && searchResults.parentElement !== document.body) {
        document.body.appendChild(searchResults);
    }
    searchResults.style.position = 'fixed';
    searchResults.style.zIndex = 99999;

    function positionResults() {
        const rect = searchInput.getBoundingClientRect();
        searchResults.style.width = `${rect.width}px`;
        searchResults.style.left = `${Math.round(rect.left)}px`;
        searchResults.style.top = `${Math.round(rect.bottom + 6)}px`; // 6px gap
    }

    window.addEventListener('resize', () => {
        if (searchResults.style.display !== 'none') positionResults();
    });
    window.addEventListener('scroll', () => {
        if (searchResults.style.display !== 'none') positionResults();
    }, true);

    // Lors de la saisie dans le champ de recherche
    searchInput.addEventListener('input', function() {
        const term = searchInput.value.trim();

        // Effacer le délai précédent s'il existe
        clearTimeout(searchTimeout);

        // Masquer les résultats si la recherche est vide
        if (!term || term.length < 2) {
            searchResults.style.display = 'none';
            return;
        }

        // Retarder la requête pour améliorer les performances (300ms après l'arrêt de la saisie)
        searchTimeout = setTimeout(() => {
            // Utiliser l'API pour rechercher les patients
            fetch(`/doctor/api/search-patients?term=${encodeURIComponent(term)}`)
                .then(response => response.json())
                .then(patients => {
                    if (patients && patients.length > 0) {
                        // Créer la liste des résultats
                        let resultsHTML = '<div class="list-group">';

                        // Convertir les données JSON en éléments de liste
                        for (let i = 0; i < patients.length; i++) {
                            const patient = patients[i];
                            resultsHTML += `
                                <a href="${patient.view_url}" class="list-group-item list-group-item-action">
                                    <div class="d-flex justify-content-between">
                                        <strong>${patient.full_name}</strong>
                                        <span class="text-muted">${patient.phone}</span>
                                    </div>
                                </a>`;
                        }

                        resultsHTML += '</div>';
                        searchResults.innerHTML = resultsHTML;
                        positionResults();
                        searchResults.style.display = 'block';
                    } else {
                        searchResults.innerHTML = '<div class="list-group"><div class="list-group-item">Aucun résultat trouvé</div></div>';
                        positionResults();
                        searchResults.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Erreur de recherche:', error);
                    searchResults.innerHTML = '<div class="list-group"><div class="list-group-item text-danger">Erreur lors de la recherche</div></div>';
                    positionResults();
                    searchResults.style.display = 'block';
                });
        }, 300);
    });

    // Masquer les résultats de recherche lors d'un clic à l'extérieur
    document.addEventListener('click', function(e) {
        if (!searchResults.contains(e.target) && e.target !== searchInput) {
            searchResults.style.display = 'none';
        }
    });

    // Reposition on input focus
    searchInput.addEventListener('focus', function() {
        if (searchResults.innerHTML.trim().length > 0) {
            positionResults();
            searchResults.style.display = 'block';
        }
    });

    // Gérer l'état du bouton effacer
    function updateClearBtn() {
        if (searchInput.value.trim().length > 0) {
            document.querySelector('.search-input-group').classList.add('search-has-text');
        } else {
            document.querySelector('.search-input-group').classList.remove('search-has-text');
        }
    }
    updateClearBtn();
    searchInput.addEventListener('input', updateClearBtn);

    document.getElementById('clear-search').addEventListener('click', function() {
        searchInput.value = '';
        updateClearBtn();
        searchResults.style.display = 'none';
        searchInput.focus();
    });

    // Soumettre le formulaire de recherche lors du clic sur le bouton
    searchBtn.addEventListener('click', function() {
        searchHidden.value = searchInput.value;
        searchForm.submit();
    });

    // Soumettre le formulaire lors de l'appui sur Entrée
    searchInput.addEventListener('keyup', function(e) {
        if (e.key === 'Enter') {
            searchHidden.value = searchInput.value;
            searchForm.submit();
        }
    });
});
</script>
{% endblock %}
