{% extends "layout.html" %}
{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col-md-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('doctor.dashboard') }}">Tableau de bord mÃ©decin</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Ordonnances prÃ©dÃ©finies (Debug)</li>
                </ol>
            </nav>
        </div>
    </div>

    <!-- Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ø³ÙŠØ· Ù„Ù„Ø²Ø± -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h3 class="mb-0">
                        <i class="fas fa-bug me-2"></i>
                        Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø²Ø± - Ù†Ø³Ø®Ø© Ø§Ù„ØªØ´Ø®ÙŠØµ
                    </h3>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <strong>ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:</strong>
                        <ol>
                            <li>Ø§ÙØªØ­ Developer Tools (F12)</li>
                            <li>Ø§Ø°Ù‡Ø¨ Ù„ØªØ¨ÙˆÙŠØ¨ Console</li>
                            <li>Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… ÙˆØµÙØ© ÙˆØ§Ù†Ù‚Ø± Ø§Ù„Ø²Ø±</li>
                            <li>Ø±Ø§Ù‚Ø¨ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙÙŠ Console</li>
                        </ol>
                    </div>
                    
                    <form id="simple_test_form">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="form-group">
                                    <label class="form-control-label mb-2">
                                        <i class="fas fa-prescription-bottle me-1"></i>
                                        Ø§Ø³Ù… Ø§Ù„ÙˆØµÙØ©:
                                    </label>
                                    <input type="text" 
                                           id="simple_prescription_name" 
                                           class="form-control" 
                                           placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„ÙˆØµÙØ©..."
                                           required>
                                </div>
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <button type="submit" class="btn btn-success w-100 btn-lg" id="simple_add_btn">
                                    <i class="fas fa-plus"></i> Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ©
                                </button>
                            </div>
                        </div>
                    </form>
                    
                    <hr>
                    
                    <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ -->
                    <div id="results_area">
                        <h5>Ø§Ù„Ù†ØªØ§Ø¦Ø¬:</h5>
                        <div id="results_content" class="border p-3 bg-light">
                            <em>Ù„Ù… ÙŠØªÙ… ØªÙ†ÙÙŠØ° Ø£ÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ø¹Ø¯...</em>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙˆØµÙØ§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© -->
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h3 class="mb-0">
                        <i class="fas fa-list me-2"></i>
                        Ø§Ù„ÙˆØµÙØ§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
                    </h3>
                </div>
                <div class="card-body">
                    <div id="current_prescriptions">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
                            </div>
                            <p class="mt-2">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆØµÙØ§Øª...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block scripts %}
<script>
console.log('ğŸš€ Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ JavaScript Ù„Ù„ØªØ´Ø®ÙŠØµ');

document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸ“„ ØªÙ… ØªØ­Ù…ÙŠÙ„ DOM - Ø¨Ø¯Ø¡ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©');
    
    // Ø§Ù„Ø¹Ù†Ø§ØµØ±
    const form = document.getElementById('simple_test_form');
    const nameInput = document.getElementById('simple_prescription_name');
    const addBtn = document.getElementById('simple_add_btn');
    const resultsContent = document.getElementById('results_content');
    const currentPrescriptions = document.getElementById('current_prescriptions');
    
    console.log('ğŸ” ÙØ­Øµ Ø§Ù„Ø¹Ù†Ø§ØµØ±:');
    console.log('   Form:', form ? 'âœ…' : 'âŒ');
    console.log('   Name Input:', nameInput ? 'âœ…' : 'âŒ');
    console.log('   Add Button:', addBtn ? 'âœ…' : 'âŒ');
    console.log('   Results:', resultsContent ? 'âœ…' : 'âŒ');
    
    // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø±
    if (addBtn) {
        addBtn.addEventListener('click', function(e) {
            console.log('ğŸ–±ï¸ ØªÙ… Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø±!');
            e.preventDefault();
            
            const name = nameInput.value.trim();
            console.log('ğŸ“ Ø§Ø³Ù… Ø§Ù„ÙˆØµÙØ©:', name);
            
            if (!name) {
                console.log('âš ï¸ Ø§Ø³Ù… Ø§Ù„ÙˆØµÙØ© ÙØ§Ø±Øº');
                updateResults('âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„ÙˆØµÙØ©', 'danger');
                return;
            }
            
            console.log('âœ… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØµØ­ÙŠØ­Ø© - Ø¨Ø¯Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„');
            testAddPrescription(name);
        });
        
        console.log('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© event listener Ù„Ù„Ø²Ø±');
    } else {
        console.log('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø±');
    }
    
    // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
    if (form) {
        form.addEventListener('submit', function(e) {
            console.log('ğŸ“ ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬');
            e.preventDefault();
            
            const name = nameInput.value.trim();
            if (name) {
                testAddPrescription(name);
            }
        });
        
        console.log('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© event listener Ù„Ù„Ù†Ù…ÙˆØ°Ø¬');
    }
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆØµÙØ§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    loadCurrentPrescriptions();
});

// Ø¯Ø§Ù„Ø© Ø§Ø®ØªØ¨Ø§Ø± Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆØµÙØ©
function testAddPrescription(name) {
    console.log('ğŸ§ª Ø¨Ø¯Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆØµÙØ©:', name);
    
    // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø²Ø±
    const addBtn = document.getElementById('simple_add_btn');
    const originalText = addBtn.innerHTML;
    addBtn.disabled = true;
    addBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±...';
    
    updateResults('ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨...', 'info');
    
    const data = { name: name };
    console.log('ğŸ“¤ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø³Ù„Ø©:', data);
    
    fetch('/doctor/api/predefined_prescriptions', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        console.log('ğŸ“¡ Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø®Ø§Ø¯Ù…:', response.status, response.statusText);
        console.log('ğŸ“¡ Headers:', response.headers);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        return response.json();
    })
    .then(data => {
        console.log('ğŸ“¥ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©:', data);
        
        if (data.success) {
            console.log('âœ… Ù†Ø¬Ø­ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„!');
            updateResults(`âœ… ${data.message}`, 'success');
            document.getElementById('simple_prescription_name').value = '';
            loadCurrentPrescriptions(); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        } else {
            console.log('âŒ ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„:', data.message);
            updateResults(`âŒ ${data.message}`, 'danger');
        }
    })
    .catch(error => {
        console.error('ğŸ’¥ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø·Ù„Ø¨:', error);
        updateResults(`ğŸ’¥ Ø®Ø·Ø£: ${error.message}`, 'danger');
    })
    .finally(() => {
        // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø±
        addBtn.disabled = false;
        addBtn.innerHTML = originalText;
        console.log('ğŸ”„ ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø±');
    });
}

// Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ØªØ§Ø¦Ø¬
function updateResults(message, type) {
    const resultsContent = document.getElementById('results_content');
    const alertClass = `alert alert-${type}`;
    
    resultsContent.innerHTML = `
        <div class="${alertClass}">
            ${message}
        </div>
        <small class="text-muted">Ø§Ù„ÙˆÙ‚Øª: ${new Date().toLocaleTimeString()}</small>
    `;
    
    console.log('ğŸ“‹ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ØªØ§Ø¦Ø¬:', message);
}

// Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆØµÙØ§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
function loadCurrentPrescriptions() {
    console.log('ğŸ“¥ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆØµÙØ§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©...');
    
    fetch('/doctor/api/predefined_prescriptions')
        .then(response => {
            console.log('ğŸ“¡ Ø§Ø³ØªØ¬Ø§Ø¨Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆØµÙØ§Øª:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('ğŸ“Š Ø§Ù„ÙˆØµÙØ§Øª Ø§Ù„Ù…Ø­Ù…Ù„Ø©:', data.length);
            
            const container = document.getElementById('current_prescriptions');
            
            if (data.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info text-center">
                        <i class="fas fa-info-circle fa-2x mb-3"></i>
                        <h5>Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØµÙØ§Øª</h5>
                        <p class="mb-0">Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø£ÙŠ ÙˆØµÙØ§Øª Ø¨Ø¹Ø¯</p>
                    </div>
                `;
            } else {
                let html = '<div class="row">';
                data.forEach(prescription => {
                    html += `
                        <div class="col-md-4 mb-3">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="fas fa-prescription-bottle me-2"></i>
                                        ${prescription.name}
                                    </h6>
                                    <p class="card-text">
                                        <small class="text-muted">
                                            ID: ${prescription.id} | 
                                            Ø£Ø¯ÙˆÙŠØ©: ${prescription.medications.length}
                                        </small>
                                    </p>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                container.innerHTML = html;
            }
        })
        .catch(error => {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆØµÙØ§Øª:', error);
            document.getElementById('current_prescriptions').innerHTML = `
                <div class="alert alert-danger text-center">
                    <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                    <h5>Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</h5>
                    <p class="mb-0">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆØµÙØ§Øª: ${error.message}</p>
                </div>
            `;
        });
}

console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø¯ÙˆØ§Ù„ JavaScript');
</script>
{% endblock scripts %}

{% block styles %}
<style>
.card {
    border: none;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    transition: box-shadow 0.15s ease-in-out;
}

.card:hover {
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
}

.card-header {
    font-weight: 600;
    border-bottom: 1px solid rgba(0, 0, 0, 0.125);
}

.btn-lg {
    font-size: 1.1rem;
    font-weight: 500;
}

.alert {
    border: none;
    border-radius: 0.5rem;
}

#results_content {
    min-height: 100px;
    border-radius: 0.375rem;
}

.spinner-border {
    width: 3rem;
    height: 3rem;
}

.btn:disabled {
    cursor: not-allowed;
}
</style>
{% endblock styles %}